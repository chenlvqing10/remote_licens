<!DOCTYPE html>
<html>
<head>
 		<meta charset="utf-8">
        <title></title>
        <meta http-equiv="pragma" content="no-cache">
        <meta http-equiv="cache-control" content="no-cache">
</head>
<body>
	<script type="text/javascript" src="easyui-lang-zh_CN.js"></script>

	<script type="text/javascript">
	
		function formatter(date){
			var year = date.getFullYear();
			var month = date.getMonth() + 1;
			var day = date.getDate();
			var hour = date.getHours();
			var min = date.getMinutes();
			var sec = date.getSeconds();
			
			console.log(date);
			
			month = month<10?('0'+month):month;
			day = day<10?('0'+day):day;
			hour = hour<10?('0'+hour):hour;
			min = min<10?'0'+min:min;
			sec = sec<10?'0'+sec:sec;
			
			return year+'/'+month+'/'+day+' '+hour+':'+min+':'+sec;
		}

		function parser(s){
			
			console.log(s);
			var reg = /[/ :]/;
			var ss=(s.split(reg));
			console.log(ss);
			var y = parseInt(ss[0],10);
			var m = parseInt(ss[1],10);
			var d = parseInt(ss[2],10);
			var hr = parseInt(ss[3],10);
			var min = parseInt(ss[4],10);
			var sec = parseInt(ss[5],10);
			
			console.log(y);console.log(m);console.log(d);
			console.log(hr);console.log(min);console.log(sec);
			if(!isNaN(y) && !isNaN(m) && !isNaN(d) && !isNaN(hr) && !isNaN(min) && !isNaN(sec)){
				return new Date(y,m-1,d,hr,min,sec);
			} else {
				return new Date();
			}
		}
		
		function pageFilter(data){
			if(typeof data.length=='number' && typeof data.splice=='function'){
				data = {
					total: data.length,
					rows: data
				}
			}
			var dg = $(this);
			var opts = dg.datagrid('options');
			var pager = dg.datagrid('getPager');
			pager.pagination({
				onSelectPage: function(pageNumber, pageSize){
					opts.pageNumber = pageNumber;
					opts.pageSize = pageSize;
					pager.pagination('refresh', {
						pageNumber: pageNumber,
						pageSize: pageSize
					});
					dg.datagrid('loadData', data);
				}
			});
			if(!data.originalRows){
				if(data.rows){
					data.originalRows = data.rows;
				}else if(data.data && data.data.rows){
					data.originalRows = data.data.rows;
				}else{
					data.originalRows = [];
				}
			}
			var start = (opts.pageNumber-1)*parseInt(opts.pageSize);
			var end = start + parseInt(opts.pageSize);
			data.rows = data.originalRows.slice(start, end);
			return data;
		}

		function radio_change_right(){
		
			var access_right = $("input[name='access_right']:checked").val();
			console.log("access_right value="+access_right);

			if(access_right == '0'){
				console.log("===0");
				$('#starttime').datetimebox('setValue','');
				$('#endtime').datetimebox('setValue','');
				$('#starttime').datetimebox('disable');
				$('#endtime').datetimebox('disable');
			}else if(access_right == '1'){
				console.log("==1");
				$('#starttime').datetimebox('enable');
				$('#endtime').datetimebox('enable');
			}else{
				console.log("other");
				$('#starttime').datetimebox('setValue','');
				$('#endtime').datetimebox('setValue','');
				$('#starttime').datetimebox('disable');
				$('#endtime').datetimebox('disable');
			}
			
		}
		
		function search_member(){
			$.ajax({
				type:'POST',
				url:'/action/searchmember',
				async: false,
				dataType:'json',
				contentType:"application/x-www-form-urlencoded",
				data:{

				},
				success:function(data){
					console.log("search data="+data);
					$('#dg').datagrid({
						data: data,
						loadFilter: pageFilter
					});
				},
				error:function(xhr,status,error){
					alert("查询失败");
				}
			
			
			});
		}

		function update_member(){
			var name = $('#name').textbox('getValue');
			var role = $("input[name='role']:checked").val();
			var access_right = $("input[name='access_right']:checked").val();
			var temporary_access_start_time = $('#starttime').datetimebox('getValue');
			var temporary_access_end_time = $('#endtime').datetimebox('getValue');

			var pg = $('#dg').datagrid('getPager');
			var opts = $('#dg').datagrid('options');
			console.log("role="+role);
			console.log("access_right="+access_right);
			console.log("temporary_access_start_time="+temporary_access_start_time);
			if(role == '')
				console.log("No input role");

			if(access_right != '')
				console.log("right !=kong");
			else
				console.log("right ==kong");
			
			var row = $('#dg').datagrid('getSelected');
			console.log(row);

			if(row == null){
					console.log("No selected.");
					alert("请选择要更新的数据！");
					return -1;
			}
			
			var id = row.id;
			var employee_number = row.employee_number;
			console.log("select id="+id);
			console.log("select employee_number="+employee_number);

			var griddata = $('#dg').datagrid('getData');
			console.log(griddata);

			var oriRows = griddata.originalRows;
			console.log("oriRows="+oriRows);
			
			var curpageindex = $('#dg').datagrid('getRowIndex', row);
			console.log("curpageindex="+curpageindex);

			var index = (opts.pageNumber-1)*(opts.pageSize) + curpageindex;
			console.log("index="+index);
			
			$.ajax({
				type:'POST',
				url:'/action/updatemember',
				async: false,
				dataType:'json',
				contentType:"application/x-www-form-urlencoded",
				async:false,
				data:{
					employee_number: employee_number,
					name: name,
					role:role,
					access_right:access_right,
					temporary_access_start_time:temporary_access_start_time,
					temporary_access_end_time:temporary_access_end_time
				},
				success:function(data){
					if (name != '')
						oriRows[index].name = name;
					if (role != '')
						oriRows[index].role = role;
					if (access_right != '')
						oriRows[index].access_right = access_right;
					if (temporary_access_start_time != '')
						oriRows[index].temporary_access_start_time = temporary_access_start_time;
					if (temporary_access_end_time != '')
						oriRows[index].temporary_access_end_time = temporary_access_end_time;
					console.log("update oriRows="+oriRows);
					$('#dg').datagrid('loadData',oriRows);
					
				},
				error:function(xhr,status,error){
					alert("更新失败");
				}
			
			
			});
		}
		
	</script>
	
	
	<div class="easyui-layout" style="height:643px;">
		<div data-options="region:'north'" style="height:15%;width:100%">
			<div style="padding-left:10px;">
				<label>姓名:</label> <input id="name" class="easyui-textbox" value="" style="width:15%;height:30px;" data-options="required:false">

				<label style="padding-left:10px">角色:</label>
				<input type="radio" id="nolist" name="role" checked="true" value=""><label>空</label>
				<input type="radio" id="whitelist" name="role" value="0"><label>0-白名单</label> 
				<input type="radio" id="blacklist" name="role" value="1"><label>1-黑名单</label>  
				<input type="radio" id="commonlist" name="role" value="2"><label>2-普通</label>

				<div style="display:inline-block; width:80px; padding-top:10px; padding-left:100px;">
					 <button id="btn1" style="width:80px; height:30px;" onclick="search_member()">查找所有</button> 
				</div>
				<div style="display:inline-block; width:80px; padding-top:10px; padding-left:20px;">
					 <button id="btn2" style="width:100px; height:30px;" onclick="update_member()">(单项)更新</button> 
				</div>
			</div>
			<div style="padding-top:10px; padding-left:10px;">
				<label>访问权限:</label>
				<input type="radio" id="noright" name="access_right" checked="true" value="" onchange="radio_change_right()"><label>空</label> 
				<input type="radio" id="permanent" name="access_right" value="0" onchange="radio_change_right()"><label>0-永久</label>  
				<input type="radio" id="temporary" name="access_right"  value="1" onchange="radio_change_right()"><label>1-临时</label> 
	
				<label style="padding-left:30px">开始时间:</label> <input id="starttime" class="easyui-datetimebox" value="" style="width:20%;height:30px;" editable="false" disabled="true" data-options="required:false, formatter:formatter, parser:parser">
				<label style="padding-left:10px">结束时间:</label> <input id="endtime" class="easyui-datetimebox" value="" style="width:20%;height:30px;" editable="false" disabled="true" data-options="required:false, formatter:formatter, parser:parser">
			</div>
		</div>
		<div data-options="region:'center'" style="height:85%;width:100%">
			<table id="dg" class="easyui-datagrid" data-options="rownumbers:true, singleSelect:true, pagination:true, pageSize:10, autoRowHeight:false, fit:true, pageList:[10,20,50,100]">
				<thead>
					<tr>
						<th field="id" width="10%">ID</th>
						<th field="employee_number" width="10%">雇员ID</th>
						<th field="name" width="10%">姓名</th>
						<th field="role" width="10%">角色</th>
						<th field="access_right" width="20%">访问权限</th>
						<th field="temporary_access_start_time" width="20%">临时访问起始时间</th>
						<th field="temporary_access_end_time" width="20%">临时访问截止时间</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>

	</div>
</body>
</html>
